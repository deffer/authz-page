<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
	<div th:replace="fragments/header :: header (name=${name})"></div>

	<div class="container uoa-container">
		<form action="#" th:action="@{/{apid}/auth/submit(apid=${apiid})}" th:object="${map}" method="post">
			<!-- original request parameters, to pass on Submit -->
			<input type="hidden" th:field="*{client_id}"/>
			<input type="hidden" th:field="*{response_type}"/>
			<input type="hidden" th:field="*{redirect_uri}"/>
			<input type="hidden" th:field="*{state}"/>
			<input type="hidden" th:field="*{scope}"/>
			<input type="hidden" th:field="*{use_fragment}"/>
			<!--div class="jumbotron" th:switch="${clientError}"-->
			<div class="panel auth-panel" th:switch="${clientError}"><div class="panel-body">
				<div th:case="${null}" id="div_ask_user">
					<div class="row">
						<div class="col-md-offset-1 col-md-10"><h2>Authorize application</h2></div>
					</div>

					<div class="row">
						<div class="col-md-offset-1 col-md-10 col-xs-12 col-xs-offset-0">
							<span class="texthighlight" th:text="${appname}"></span>
							wants to access your profile. If you approve, authorization code will be sent to <span class="urlhighlight" th:text="${apphost}" th:title="${appurl}"></span>
							This code can be used to access information about you.
						</div>
					</div>
					<div class="row">
						<div class="alert alert-warning" role="alert" th:if="${! #strings.isEmpty(clientWarning)}" id="div_warn_callback_override">
							This application was registered with a different callback <span class="urlhighlight" th:text="${clientWarning}"></span>.
							Do not accept his request if you don't trust application which sent you here.
						</div>
					</div>

					<div th:if="${rememberme==true and #strings.isEmpty(clientWarning)}" >
						<hr/>
						<div th:if="${map.response_type=='token'}" class="row">
						<div class="col-md-offset-1 col-xs-offset-0 col-xs-6">
							<label for="remember">Remember my decision</label>
								<!--p class="margin-bottom-s">Remember my decision:</p-->
							<select class="form-control" name="remember" id="remember">
								<option id="remember-not" value="remember-not"
									title="You will be prompted again next time you use the application">
									No, ask me again next time
								</option>
								<option id="remember-2weeks" value="remember-2weeks"
									title="If you want to continue to use the app after two weeks, you will be asked again.">
									For two weeks
								</option>
								<option id="remember-forever" value="remember-forever"
									title="You will not be asked to authorize this access again. You can revoke it any time from your Application pages">
									Until I revoke it
								</option>
							</select>
							<div style="font-size: 70%;">
								<a href="/self" target="_blank">View my tokens and applications</a>
							</div>
						</div>
						</div>

						<div th:if="${map.response_type=='code'}" class="row">
							<div class="col-md-offset-1 col-xs-offset-0 col-xs-6">
								<div class="checkbox">
									<label>
										<input type="checkbox" name="remember" value="remember-forever"/>
										Dont ask again
										<i class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="top"
										   title="You can revoke this access at any time from your Application pages"></i>
									</label>
								</div>
								<div style="font-size: 90%;">
									<a href="/self" target="_blank">View my tokens and applications</a>
								</div>
							</div>

						</div>

						<hr/>
					</div>

					<div class="row">
						<div class="col-md-offset-1 col-md-6 col-xs-12 col-xs-offset-0">
							<button type="submit" class="btn btn-allow" value="Allow" name="actionAllow">Authorize application</button>
						</div>
						<div class="col-md-3 col-xs-12">
							<button type="submit" class="btn btn-warning" value="Deny" name="actionDeny">Deny</button>
						</div>
					</div>
				</div>


				<div th:case="noauth_api" id="div_api_noauth">
					<div class="media-left">
						<i class="fa fa-hand-paper-o" aria-hidden="true"></i>
					</div>
					<div class="media-body">
						<h2 class="media-heading">Authorize application</h2>
						<p>Requested API access (OAuth2) is not supported with this API. There could be two reasons for seeing this error:
							the client application you are using is outdated or our API is not configured properly. We have logged this issue
							with our support team for investigation.</p>
					</div>
				</div>
				<div th:case="unknown_api" id="div_error_api_not_found">
					<div class="media-left">
						<i class="fa fa-question" aria-hidden="true"></i>
					</div>
					<div class="media-body">
						<h2 class="media-heading">Authorize application</h2>
						<p>This is a request for an unknown API. The link is broken or the API was decommissioned. Please report this error to the application developer.</p>
					</div>
				</div>
				<div th:case="unknown_client" id="div_error_client_not_found">
					<div class="media-left">
						<i class="fa fa-frown-o" aria-hidden="true"></i>
					</div>
					<div class="media-body">
						<h2 class="media-heading">Authorize application</h2>
						<p>Sorry, application which sent you to this page is not registered with us. We've  blocked this request to keep you safe.</p>
					</div>
				</div>
				<div th:case="callback_match" id="div_error_callback_nomatch">
					<h2>Authorize application</h2>
					<p>We couldn't verify the identity of the calling application - mismatched callback url. We've blocked this request to keep you safe.
					You can report this error to the application which sent you here.
					</p>
					<div class="alert alert-danger" role="alert">
						Application <span class="texthighlight" th:text="${appname}"></span>
						is registered as <span class="urlhighlight" th:text="${clientWarning}"></span>
						while current request wants to send the access code to <span class="urlhighlight" th:text="${appurl}"></span>
					</div>
					<div class="row">
						<a href="https://auckland.ac.nz" class="btn btn-allow">Home</a>
					</div>

				</div>
			</div></div> <!-- end of panel -->

			<div class="row"  th:if="${scopes != null } and not ${scopes.size()==0}">
				<div class="col-sm-12" style="margin-top: 40px;">
					<h4 class="scopes-header">Requested access</h4>
				</div>
			</div>
			<div class="row">
				<div th:each="ascope: ${scopes}" class="col-sm-6">
					<div class="bs-callout" th:classappend="${ascope.warn} ? bs-callout-danger : bs-callout-primary">
						<h4 th:text="${ascope.key}"></h4>
						<p th:text="${ascope.value}"> </p>
					</div>
				</div>
			</div>

			<div class="panel panel-danger" th:if="${debug}">
				<div class="panel-heading panel-heading-collapsible">
					<div class="panel-title">
						<a role="button" data-toggle="collapse" href="#collapseDebugPanel" aria-expanded="false" class="collapsed">
							Debug services
						</a>
					</div>
				</div>
				<div class="panel-body collapse" id="collapseDebugPanel">

					<div class="panel">
						<div class="panel-body">
						<h4>Changing upi</h4>
						<p> You can override <code>upi</code> of logged-in user. Type new UPI and press Allow, Deny, or Enter Debug</p>
						<p><input type="text" th:field="*{user_id}"/></p>
						</div>
					</div>


					<div class="panel">
						<div class="panel-body">
						<h4>Debug mode</h4>
						<p> You can use Debug mode to test approval step-by-step. Before redirecting back to application, you can see Kong's response.</p>
						<p><button type="submit" class="btn" name="actionDebug" value="Debug" > Enter Debug</button></p>
						</div>
					</div>
				</div>
			</div>

		</form>

	</div>
	<!-- /container -->


	<div th:replace="fragments/footer :: footer"></div>
</body>
</html>